import{B as ce}from"./basedecoder-mEJI0nVf.js";const O=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),Y=4017,Z=799,$=3406,N=2276,Q=1567,W=3784,M=5793,K=2896;function te(S,l){let s=0;const u=[];let P=16;for(;P>0&&!S[P-1];)--P;u.push({children:[],index:0});let p=u[0],k;for(let t=0;t<P;t++){for(let h=0;h<S[t];h++){if(p=u.pop(),!p)throw new Error("buildHuffmanTable: codeLength mismatch");for(p.children[p.index]=l[s];p.index>0;)if(p=u.pop(),!p)throw new Error("buildHuffmanTable: codeLength mismatch");for(p.index++,u.push(p);u.length<=t;)u.push(k={children:[],index:0}),p.children[p.index]=k.children,p=k;s++}t+1<P&&(u.push(k={children:[],index:0}),p.children[p.index]=k.children,p=k)}return u[0].children}function ie(S,l,s,u,P,p,k,t,h){const{mcusPerLine:d,progressive:c}=s,r=l;let F=l,i=0,b=0;function x(){if(b>0)return b--,i>>b&1;if(i=S[F++],i===255){const a=S[F++];if(a)throw new Error(`unexpected marker: ${(i<<8|a).toString(16)}`)}return b=7,i>>>7}function m(a){let f=a,w;for(;(w=x())!==null;){if(f=f[w],typeof f=="number")return f;if(typeof f!="object")throw new Error("invalid huffman sequence")}return null}function E(a){let f=a,w=0;for(;f>0;){const L=x();if(L===null)return;w=w<<1|L,--f}return w}function C(a){const f=E(a);if(f!==void 0)return f>=1<<a-1?f:f+(-1<<a)+1}function v(a,f){const w=m(a.huffmanTableDC),L=w===0?0:C(w);a.pred+=L,f[0]=a.pred;let A=1;for(;A<64;){const T=m(a.huffmanTableAC);if(T===null)throw new Error("Unexpected end of data in AC coefficient decoding");const y=T&15,q=T>>4;if(y===0){if(q<15)break;A+=16}else{A+=q;const U=O[A];f[U]=C(y),A++}}}function D(a,f){const w=m(a.huffmanTableDC),L=C(w);if(L===void 0)throw new Error("Unexpected end of data in DC coefficient decoding");const A=w===0?0:L<<h;a.pred+=A,f[0]=a.pred}function o(a,f){f[0]|=x()<<h}let n=0;function g(a,f){if(n>0){n--;return}let w=p;const L=k;for(;w<=L;){const A=m(a.huffmanTableAC);if(A===null)throw new Error("Unexpected end of data in AC coefficient decoding");const T=A&15,y=A>>4;if(T===0){if(y<15){const q=E(y);if(q===void 0)throw new Error("Unexpected end of data in AC coefficient decoding");n=q+(1<<y)-1;break}w+=16}else{w+=y;const q=O[w],U=C(T);if(U===void 0)throw new Error("Unexpected end of data in AC coefficient decoding");f[q]=U*(1<<h),w++}}}let e=0,_;function oe(a,f){let w=p;const L=k;let A=0;for(;w<=L;){const T=O[w],y=f[T]<0?-1:1;switch(e){case 0:{const q=m(a.huffmanTableAC);if(q===null)throw new Error("Unexpected end of data in AC coefficient decoding");const U=q&15;if(A=q>>4,U===0)if(A<15){const ne=E(A);if(ne===void 0)throw new Error("Unexpected end of data in AC coefficient decoding");n=ne+(1<<A),e=4}else A=16,e=1;else{if(U!==1)throw new Error("invalid ACn encoding");_=C(U),e=A?2:3}continue}case 1:case 2:f[T]?f[T]+=(x()<<h)*y:(A--,A===0&&(e=e===2?3:0));break;case 3:f[T]?f[T]+=(x()<<h)*y:(f[T]=_<<h,e=0);break;case 4:f[T]&&(f[T]+=(x()<<h)*y);break}w++}e===4&&(n--,n===0&&(e=0))}function se(a,f,w,L,A){const T=w/d|0,y=w%d,q=T*a.v+L,U=y*a.h+A;f(a,a.blocks[q][U])}function re(a,f,w){const L=w/a.blocksPerLine|0,A=w%a.blocksPerLine;f(a,a.blocks[L][A])}const V=u.length;let R,j,G,X,I,H;c?p===0?H=t===0?D:o:H=t===0?g:oe:H=v;let B=0,z,J;V===1?J=u[0].blocksPerLine*u[0].blocksPerColumn:J=d*s.mcusPerColumn;const ee=P||J;for(;B<J;){for(j=0;j<V;j++)u[j].pred=0;if(n=0,V===1)for(R=u[0],I=0;I<ee;I++)re(R,H,B),B++;else for(I=0;I<ee;I++){for(j=0;j<V;j++){R=u[j];const{h:a,v:f}=R;for(G=0;G<f;G++)for(X=0;X<a;X++)se(R,H,B,G,X)}if(B++,B===J)break}if(b=0,z=S[F]<<8|S[F+1],z<65280)throw new Error("marker was not found");if(z>=65488&&z<=65495)F+=2;else break}return F-r}function le(S,l){const s=[],{blocksPerLine:u,blocksPerColumn:P}=l,p=u<<3,k=new Int32Array(64),t=new Uint8Array(64);function h(d,c,r){const F=l.quantizationTable;let i,b,x,m,E,C,v,D,o;const n=r;let g;for(g=0;g<64;g++)n[g]=d[g]*F[g];for(g=0;g<8;++g){const e=8*g;if(n[1+e]===0&&n[2+e]===0&&n[3+e]===0&&n[4+e]===0&&n[5+e]===0&&n[6+e]===0&&n[7+e]===0){o=M*n[0+e]+512>>10,n[0+e]=o,n[1+e]=o,n[2+e]=o,n[3+e]=o,n[4+e]=o,n[5+e]=o,n[6+e]=o,n[7+e]=o;continue}i=M*n[0+e]+128>>8,b=M*n[4+e]+128>>8,x=n[2+e],m=n[6+e],E=K*(n[1+e]-n[7+e])+128>>8,D=K*(n[1+e]+n[7+e])+128>>8,C=n[3+e]<<4,v=n[5+e]<<4,o=i-b+1>>1,i=i+b+1>>1,b=o,o=x*W+m*Q+128>>8,x=x*Q-m*W+128>>8,m=o,o=E-v+1>>1,E=E+v+1>>1,v=o,o=D+C+1>>1,C=D-C+1>>1,D=o,o=i-m+1>>1,i=i+m+1>>1,m=o,o=b-x+1>>1,b=b+x+1>>1,x=o,o=E*N+D*$+2048>>12,E=E*$-D*N+2048>>12,D=o,o=C*Z+v*Y+2048>>12,C=C*Y-v*Z+2048>>12,v=o,n[0+e]=i+D,n[7+e]=i-D,n[1+e]=b+v,n[6+e]=b-v,n[2+e]=x+C,n[5+e]=x-C,n[3+e]=m+E,n[4+e]=m-E}for(g=0;g<8;++g){const e=g;if(n[8+e]===0&&n[16+e]===0&&n[24+e]===0&&n[32+e]===0&&n[40+e]===0&&n[48+e]===0&&n[56+e]===0){o=M*r[g+0]+8192>>14,n[0+e]=o,n[8+e]=o,n[16+e]=o,n[24+e]=o,n[32+e]=o,n[40+e]=o,n[48+e]=o,n[56+e]=o;continue}i=M*n[0+e]+2048>>12,b=M*n[32+e]+2048>>12,x=n[16+e],m=n[48+e],E=K*(n[8+e]-n[56+e])+2048>>12,D=K*(n[8+e]+n[56+e])+2048>>12,C=n[24+e],v=n[40+e],o=i-b+1>>1,i=i+b+1>>1,b=o,o=x*W+m*Q+2048>>12,x=x*Q-m*W+2048>>12,m=o,o=E-v+1>>1,E=E+v+1>>1,v=o,o=D+C+1>>1,C=D-C+1>>1,D=o,o=i-m+1>>1,i=i+m+1>>1,m=o,o=b-x+1>>1,b=b+x+1>>1,x=o,o=E*N+D*$+2048>>12,E=E*$-D*N+2048>>12,D=o,o=C*Z+v*Y+2048>>12,C=C*Y-v*Z+2048>>12,v=o,n[0+e]=i+D,n[56+e]=i-D,n[8+e]=b+v,n[48+e]=b-v,n[16+e]=x+C,n[40+e]=x-C,n[24+e]=m+E,n[32+e]=m-E}for(g=0;g<64;++g){const e=128+(n[g]+8>>4);e<0?c[g]=0:e>255?c[g]=255:c[g]=e}}for(let d=0;d<P;d++){const c=d<<3;for(let r=0;r<8;r++)s.push(new Uint8Array(p));for(let r=0;r<u;r++){h(l.blocks[d][r],t,k);let F=0;const i=r<<3;for(let b=0;b<8;b++){const x=s[c+b];for(let m=0;m<8;m++)x[i+m]=t[F++]}}}return s}class fe{constructor(){this.jfif=null,this.adobe=null,this.quantizationTables=[],this.huffmanTablesAC=[],this.huffmanTablesDC=[],this.frames=[]}resetFrames(){this.frames=[]}parse(l){let s=0;function u(){const t=l[s]<<8|l[s+1];return s+=2,t}function P(){const t=u(),h=l.subarray(s,s+t-2);return s+=h.length,h}function p(t){let h=0,d=0,c,r;for(r in t.components)t.components.hasOwnProperty(r)&&(c=t.components[r],h<c.h&&(h=c.h),d<c.v&&(d=c.v));const F=Math.ceil(t.samplesPerLine/8/h),i=Math.ceil(t.scanLines/8/d);for(r in t.components)if(t.components.hasOwnProperty(r)){c=t.components[r];const b=Math.ceil(Math.ceil(t.samplesPerLine/8)*c.h/h),x=Math.ceil(Math.ceil(t.scanLines/8)*c.v/d),m=F*c.h,E=i*c.v,C=[];for(let v=0;v<E;v++){const D=[];for(let o=0;o<m;o++)D.push(new Int32Array(64));C.push(D)}c.blocksPerLine=b,c.blocksPerColumn=x,c.blocks=C}t.maxH=h,t.maxV=d,t.mcusPerLine=F,t.mcusPerColumn=i}let k=u();if(k!==65496)throw new Error("SOI not found");for(k=u();k!==65497;){switch(k){case 65280:break;case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:{const t=P();k===65504&&t[0]===74&&t[1]===70&&t[2]===73&&t[3]===70&&t[4]===0&&(this.jfif={version:{major:t[5],minor:t[6]},densityUnits:t[7],xDensity:t[8]<<8|t[9],yDensity:t[10]<<8|t[11],thumbWidth:t[12],thumbHeight:t[13],thumbData:t.subarray(14,14+3*t[12]*t[13])}),k===65518&&t[0]===65&&t[1]===100&&t[2]===111&&t[3]===98&&t[4]===101&&t[5]===0&&(this.adobe={version:t[6],flags0:t[7]<<8|t[8],flags1:t[9]<<8|t[10],transformCode:t[11]});break}case 65499:{const h=u()+s-2;for(;s<h;){const d=l[s++],c=new Int32Array(64);if(d>>4===0)for(let r=0;r<64;r++){const F=O[r];c[F]=l[s++]}else if(d>>4===1)for(let r=0;r<64;r++){const F=O[r];c[F]=u()}else throw new Error("DQT: invalid table spec");this.quantizationTables[d&15]=c}break}case 65472:case 65473:case 65474:{u();const t={extended:k===65473,progressive:k===65474,precision:l[s++],scanLines:u(),samplesPerLine:u(),components:{},componentsOrder:[]},h=l[s++];let d;for(let c=0;c<h;c++){d=l[s];const r=l[s+1]>>4,F=l[s+1]&15,i=l[s+2];t.componentsOrder.push(d),t.components[d]={h:r,v:F,quantizationIdx:i},s+=3}p(t),this.frames.push(t);break}case 65476:{const t=u();for(let h=2;h<t;){const d=l[s++],c=new Uint8Array(16);let r=0;for(let i=0;i<16;i++,s++)c[i]=l[s],r+=c[i];const F=new Uint8Array(r);for(let i=0;i<r;i++,s++)F[i]=l[s];h+=17+r,d>>4===0?this.huffmanTablesDC[d&15]=te(c,F):this.huffmanTablesAC[d&15]=te(c,F)}break}case 65501:u(),this.resetInterval=u();break;case 65498:{u();const t=l[s++],h=[],d=this.frames[0];for(let b=0;b<t;b++){const x=d.components[l[s++]],m=l[s++];x.huffmanTableDC=this.huffmanTablesDC[m>>4],x.huffmanTableAC=this.huffmanTablesAC[m&15],h.push(x)}const c=l[s++],r=l[s++],F=l[s++],i=ie(l,s,d,h,this.resetInterval,c,r,F>>4,F&15);s+=i;break}case 65535:l[s]!==255&&s--;break;default:if(l[s-3]===255&&l[s-2]>=192&&l[s-2]<=254){s-=3;break}throw new Error(`unknown JPEG marker ${k.toString(16)}`)}k=u()}}getResult(){const{frames:l}=this;if(this.frames.length===0)throw new Error("no frames were decoded");this.frames.length>1&&console.warn("more than one frame is not supported");for(let c=0;c<this.frames.length;c++){const r=this.frames[c].components;for(const F of Object.keys(r))r[F].quantizationTable=this.quantizationTables[r[F].quantizationIdx],delete r[F].quantizationIdx}const s=l[0],{components:u,componentsOrder:P}=s,p=[],k=s.samplesPerLine,t=s.scanLines;for(let c=0;c<P.length;c++){const r=u[P[c]];p.push({lines:le(s,r),scaleX:r.h/s.maxH,scaleY:r.v/s.maxV})}const h=new Uint8Array(k*t*p.length);let d=0;for(let c=0;c<t;++c)for(let r=0;r<k;++r)for(let F=0;F<p.length;++F){const i=p[F];h[d]=i.lines[0|c*i.scaleY][0|r*i.scaleX],++d}return h}}class ue extends ce{constructor(l){super(l),this.reader=new fe,l.JPEGTables&&this.reader.parse(l.JPEGTables)}decodeBlock(l){return this.reader.resetFrames(),this.reader.parse(new Uint8Array(l)),this.reader.getResult().buffer}}export{ue as default};
